<!DOCTYPE html>
<html lang="en">
<head>
    <title>Charades Pro</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2D3436">

    <style>
        :root {
            --primary: #6C5CE7;
            --secondary: #00CEC9;
            --dark: #2D3436;
            --surface: #3a4244;
            --light: #DFE6E9;
            --danger: #ff7675;
            --success: #00b894;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            text-align: center;
            margin: 0; padding: 0;
            background: var(--dark);
            color: white;
            min-height: 100vh;
            display: flex; flex-direction: column;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .screen { display: none; padding: 20px; width: 100%; max-width: 600px; margin: 0 auto; flex-grow: 1; animation: fadeIn 0.3s ease; }
        .active { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        h1, h2, h3 { color: var(--secondary); margin: 0 0 15px 0; }
        h1 { font-size: 2rem; }
        
        input, select, textarea {
            padding: 15px; border-radius: 12px; border: 2px solid #444; width: 100%; margin-bottom: 15px;
            font-size: 16px; background: var(--surface); color: white; outline: none; transition: border-color 0.2s;
        }
        input:focus, select:focus { border-color: var(--secondary); }

        .btn {
            background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px;
            font-size: 1.1rem; font-weight: 600; cursor: pointer; width: 100%; margin-bottom: 12px;
            touch-action: manipulation; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .btn:active { transform: scale(0.96); }
        .btn-sec { background: #555; }
        .btn-success { background: var(--success); }

        .card { background: var(--surface); padding: 20px; border-radius: 16px; width: 100%; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .big-word { font-size: 2.5rem; font-weight: 800; color: var(--secondary); margin: 20px 0; word-wrap: break-word; }
        .timer-box { font-size: 5rem; font-weight: 900; color: var(--danger); font-variant-numeric: tabular-nums; }
        .score-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 1.1rem; }
        #team-inputs { width: 100%; display: grid; gap: 10px; }
        #preview-banner { background: #e17055; color: white; padding: 5px; font-size: 0.8rem; display: none; }
    </style>
</head>
<body>

    <div id="preview-banner">‚ö†Ô∏è Preview / Offline Mode</div>

    <!-- 1. LANDING PAGE -->
    <div id="screen-landing" class="screen active">
        <h1>üé≠ Family Charades</h1>
        <p style="color: #ccc; margin-bottom: 30px;">The Ultimate Party Game</p>
        <button class="btn" onclick="showScreen('screen-create')">üëë Start New Game (Host)</button>
        <button class="btn btn-sec" onclick="showScreen('screen-join')">üëã Join Existing Game</button>
        <div onclick="showScreen('screen-admin-login')" style="color:#888; text-decoration:underline; padding:10px; cursor:pointer;">Admin Login</div>
    </div>

    <!-- 2. ADMIN -->
    <div id="screen-admin-login" class="screen">
        <h2>Admin Login</h2>
        <input type="text" id="adminUser" placeholder="Username (admin)" autocapitalize="none">
        <input type="password" id="adminPass" placeholder="Password (charades123)">
        <button class="btn" onclick="adminLogin()">Login</button>
        <button class="btn btn-sec" onclick="showScreen('screen-landing')">Back</button>
    </div>

    <div id="screen-admin-dash" class="screen">
        <h2>Add Words</h2>
        <div class="card">
            <select id="addType"><option value="Movie">Movie</option><option value="Song">Song</option></select>
            <select id="addDiff"><option value="Easy">Easy</option><option value="Medium">Medium</option><option value="Hard">Hard</option></select>
            <textarea id="addWords" rows="4" placeholder="Words separated by comma"></textarea>
        </div>
        <button class="btn btn-success" onclick="addWords()">Add Words</button>
        <p id="admin-msg" style="color: var(--success); height: 20px;"></p>
        <button class="btn btn-sec" onclick="showScreen('screen-landing')">Logout</button>
    </div>

    <!-- 3. CREATE ROOM -->
    <div id="screen-create" class="screen">
        <h2>Create Room</h2>
        <input type="text" id="c-roomName" placeholder="Room Name">
        <select id="c-gameType"><option value="Both">Movies & Songs</option><option value="Movie">Movies Only</option><option value="Song">Songs Only</option></select>
        <select id="c-teams" onchange="updateTeamInputs()"><option value="2">2 Teams</option><option value="3">3 Teams</option><option value="4">4 Teams</option></select>
        <div id="team-inputs"><input type="text" id="team1" value="Team A"><input type="text" id="team2" value="Team B"></div>
        <input type="number" id="c-duration" placeholder="Timer (sec)" value="60">
        <button class="btn" onclick="createRoom()">Create Room</button>
        <button class="btn btn-sec" onclick="showScreen('screen-landing')">Back</button>
    </div>

    <!-- 4. JOIN ROOM -->
    <div id="screen-join" class="screen">
        <h2>Join Game</h2>
        <input type="text" id="j-code" placeholder="Room Code (4 Letters)" maxlength="4">
        <input type="text" id="j-name" placeholder="Your Name">
        <button class="btn" onclick="fetchRoomInfo()">Next</button>
        <button class="btn btn-sec" onclick="showScreen('screen-landing')">Back</button>
    </div>

    <!-- 4b. PICK TEAM -->
    <div id="screen-pick-team" class="screen">
        <h2>Pick Your Team</h2>
        <div id="team-buttons" style="width: 100%;"></div>
    </div>

    <!-- 5. GAME LOBBY -->
    <div id="screen-game" class="screen">
        <h2 id="g-roomName">Room</h2>
        <div class="card">
            <h3 style="border-bottom:1px solid #555;">üèÜ Scoreboard</h3>
            <div id="scoreboard"></div>
        </div>
        <div id="game-status-area" style="width: 100%;">
            <button class="btn" id="btn-myturn" onclick="startTurnSetup()">It's My Turn!</button>
            <p id="status-msg" style="color: #aaa; margin-top: 20px;">Waiting for turn...</p>
        </div>
    </div>

    <!-- 6. TURN SETUP -->
    <div id="screen-setup" class="screen">
        <h2>Your Turn!</h2>
        <div class="card">
            <label>Category</label>
            <select id="t-type"><option value="Movie">üé¨ Movie</option><option value="Song">üéµ Song</option></select>
            <label>Difficulty</label>
            <select id="t-diff"><option value="Easy">üü¢ Easy (x0.6)</option><option value="Medium">üü° Medium (x0.8)</option><option value="Hard">üî¥ Hard (x1.0)</option></select>
        </div>
        <button class="btn" onclick="confirmOptions()">Get Word</button>
        <button class="btn btn-sec" onclick="showScreen('screen-game')">Cancel</button>
    </div>

    <!-- 7. ACTOR SCREEN -->
    <div id="screen-actor" class="screen">
        <h3>You are acting!</h3>
        <div class="card" style="border: 2px solid var(--secondary);">
            <div id="actor-word" class="big-word">LOADING...</div>
            <p id="actor-meta" style="background: rgba(255,255,255,0.1); padding: 5px;"></p>
        </div>
        <button class="btn btn-success" id="btn-start-act" onclick="startActing()">‚ñ∂Ô∏è START TIMER</button>
        <div id="actor-controls" style="display:none; width: 100%;">
            <div class="timer-box" id="actor-timer">60</div>
            <button class="btn btn-success" onclick="wordFound()" style="padding: 25px;">‚úÖ GOT IT!</button>
        </div>
    </div>

    <!-- 8. GUESSER SCREEN -->
    <div id="screen-guesser" class="screen">
        <h2 id="guesser-status">Gamer is ready...</h2>
        <div class="timer-box" id="guesser-timer" style="display:none; margin-top: 30px;">60</div>
    </div>

    <!-- SOCKET IO & MOCK LOGIC -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        // --- MOCK SOCKET CLASS (For Preview Mode) ---
        class MockSocket {
            constructor() {
                console.log("MOCK SOCKET INITIALIZED");
                this.id = "mock-user-" + Math.floor(Math.random()*1000);
                this.listeners = {};
                // Default Mock Data
                this.mockData = {
                    roomCode: 'TEST',
                    scores: {'Team A': 0, 'Team B': 0},
                    config: { roomName: 'Test Room', teamNames: ['Team A', 'Team B'] }
                };
            }
            on(event, callback) { this.listeners[event] = callback; }
            emit(event, data) {
                console.log(`Mock Emit: ${event}`, data);
                // Simulate Server Responses
                if (event === 'create_room') {
                    this.mockData.config = data;
                    this.mockData.scores = {};
                    data.teamNames.forEach(t => this.mockData.scores[t] = 0);
                    setTimeout(() => this.trigger('room_created', { roomCode: 'TEST', teamNames: data.teamNames }), 500);
                }
                if (event === 'join_room') {
                    setTimeout(() => this.trigger('update_lobby', { scores: this.mockData.scores, config: this.mockData.config }), 300);
                }
                if (event === 'setup_turn') this.trigger('show_turn_options');
                if (event === 'get_word') {
                    const words = ["Titanic", "Frozen", "Inception", "Thriller"];
                    const w = words[Math.floor(Math.random()*words.length)];
                    this.trigger('receive_word', { word: w, type: data.type, difficulty: data.difficulty });
                }
                if (event === 'start_acting') this.trigger('game_started', { duration: 60 });
                if (event === 'word_found') {
                    this.mockData.scores['Team A'] += 10; // Mock score update
                    this.trigger('turn_ended', { success: true, team: 'Team A', score: 10 });
                    this.trigger('update_scores', this.mockData.scores);
                }
            }
            trigger(event, data) { if (this.listeners[event]) this.listeners[event](data); }
        }

        // --- INIT SOCKET ---
        let socket;
        if (typeof io !== 'undefined') {
            try {
                socket = io(); // Try real connection
                socket.on("connect_error", () => { useMock(); }); // Fallback if connection fails
            } catch(e) { useMock(); }
        } else {
            useMock();
        }

        function useMock() {
            console.warn("Using Mock Socket for Preview");
            document.getElementById('preview-banner').style.display = 'block';
            socket = new MockSocket();
        }

        // --- APP LOGIC ---
        let myRoomCode = "";
        let myName = "";
        let myTeam = "";

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => { s.classList.remove('active'); s.style.display = 'none'; });
            const active = document.getElementById(id);
            active.style.display = 'flex';
            setTimeout(() => active.classList.add('active'), 10);
        }

        // Create Room
        function updateTeamInputs() {
            const count = document.getElementById('c-teams').value;
            const div = document.getElementById('team-inputs');
            div.innerHTML = '';
            for(let i=1; i<=count; i++) div.innerHTML += `<input type="text" id="team${i}" placeholder="Team ${i}" value="Team ${String.fromCharCode(64+i)}">`;
        }

        function createRoom() {
            const roomName = document.getElementById('c-roomName').value || "Family Game";
            const count = document.getElementById('c-teams').value;
            const teamNames = [];
            for(let i=1; i<=count; i++) teamNames.push(document.getElementById(`team${i}`).value);
            socket.emit("create_room", { roomName, teamNames, duration: 60 });
        }

        // Listeners
        if(socket) {
            socket.on("room_created", (data) => {
                document.getElementById('j-code').value = data.roomCode;
                showScreen('screen-join');
            });

            socket.on("update_lobby", (data) => {
                const scoreDiv = document.getElementById('scoreboard');
                scoreDiv.innerHTML = '';
                for (const [team, score] of Object.entries(data.scores)) {
                    scoreDiv.innerHTML += `<div class="score-row"><span>${team}</span><span style="font-weight:bold; color:var(--secondary);">${score}</span></div>`;
                }
                document.getElementById('g-roomName').innerText = `${data.config.roomName} (TEST)`;
                
                // Show Team Picker
                if (myTeam === "") {
                    const btnDiv = document.getElementById('team-buttons');
                    btnDiv.innerHTML = '';
                    data.config.teamNames.forEach(t => {
                        const btn = document.createElement('button');
                        btn.className = "btn";
                        btn.innerText = "Join " + t;
                        btn.onclick = () => { myTeam = t; showScreen('screen-game'); };
                        btnDiv.appendChild(btn);
                    });
                    showScreen('screen-pick-team');
                }
            });

            socket.on("show_turn_options", () => showScreen('screen-setup'));
            
            socket.on("receive_word", (wordObj) => {
                showScreen('screen-actor');
                document.getElementById('actor-word').innerText = wordObj.word;
                document.getElementById('actor-meta').innerText = `${wordObj.type} ‚Ä¢ ${wordObj.difficulty}`;
                document.getElementById('btn-start-act').style.display = "block";
                document.getElementById('actor-controls').style.display = "none";
            });

            socket.on("game_started", ({ duration }) => {
                document.getElementById('btn-start-act').style.display = "none";
                document.getElementById('actor-controls').style.display = "block";
                startTimer('actor-timer', duration);
            });

            socket.on("turn_ended", (data) => {
                clearInterval(timerInterval);
                showScreen('screen-game');
                if(data.success) alert(`‚úÖ Word Found! Team ${data.team} scored!`);
                else alert("‚è∞ Time's up!");
            });
            
            socket.on("update_scores", (scores) => {
                const scoreDiv = document.getElementById('scoreboard');
                scoreDiv.innerHTML = '';
                for (const [team, score] of Object.entries(scores)) scoreDiv.innerHTML += `<div class="score-row"><span>${team}</span><span style="font-weight:bold; color:var(--secondary);">${score}</span></div>`;
            });
        }

        function fetchRoomInfo() { socket.emit("join_room", { roomCode: 'TEST', playerName: 'Test', teamName: 'Pending' }); }
        function startTurnSetup() { socket.emit("setup_turn", {}); }
        function confirmOptions() { 
            const type = document.getElementById('t-type').value;
            const diff = document.getElementById('t-diff').value;
            socket.emit("get_word", { type, difficulty: diff }); 
        }
        function startActing() { socket.emit("start_acting", {}); }
        function wordFound() { socket.emit("word_found", {}); }

        let timerInterval;
        function startTimer(elemId, seconds) {
            const el = document.getElementById(elemId);
            el.innerText = seconds;
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                seconds--; el.innerText = seconds;
                if(seconds <= 0) clearInterval(timerInterval);
            }, 1000);
        }

        // Admin Mock
        function adminLogin() { showScreen('screen-admin-dash'); }
        function addWords() { 
            document.getElementById('admin-msg').innerText = "‚úÖ Words Added (Local)"; 
            setTimeout(() => document.getElementById('admin-msg').innerText = "", 2000);
        }
    </script>
</body>
</html>
