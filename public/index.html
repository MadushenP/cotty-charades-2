<!DOCTYPE html>
<html lang="en">
<head>
    <title>Kirthu's Bday Charades</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2D3436">

    <style>
        :root { --primary: #6C5CE7; --secondary: #00CEC9; --dark: #2D3436; --surface: #3a4244; --light: #DFE6E9; --danger: #ff7675; --success: #00b894; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            text-align: center; margin: 0; padding: 0; background: var(--dark); color: white;
            min-height: 100vh; display: flex; flex-direction: column; padding-bottom: env(safe-area-inset-bottom);
        }
        .screen { display: none; padding: 20px; width: 100%; max-width: 600px; margin: 0 auto; flex-grow: 1; }
        .active { display: flex; flex-direction: column; align-items: center; justify-content: center; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        h1, h2, h3 { color: var(--secondary); margin: 0 0 15px 0; }
        h1 { font-size: 2rem; }
        
        input, select, textarea {
            padding: 15px; border-radius: 12px; border: 2px solid #444; width: 100%; margin-bottom: 15px;
            font-size: 16px; background: var(--surface); color: white; outline: none; transition: border-color 0.2s;
        }
        input:focus, select:focus { border-color: var(--secondary); }

        .btn {
            background: var(--primary); color: white; border: none; padding: 16px; border-radius: 12px;
            font-size: 1.1rem; font-weight: 600; cursor: pointer; width: 100%; margin-bottom: 12px;
            touch-action: manipulation; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .btn:active { transform: scale(0.96); }
        .btn-sec { background: #555; }
        .btn-success { background: var(--success); }

        .card { background: var(--surface); padding: 20px; border-radius: 16px; width: 100%; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .big-word { font-size: 2.5rem; font-weight: 800; color: var(--secondary); margin: 20px 0; word-wrap: break-word; }
        .timer-box { font-size: 5rem; font-weight: 900; color: var(--danger); font-variant-numeric: tabular-nums; }
        .score-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 1.1rem; }
        #team-inputs { width: 100%; display: grid; gap: 10px; }
    </style>
</head>
<body>

    <!-- 1. LANDING PAGE -->
    <div id="screen-landing" class="screen active">
        <h1>üé≠ Kirthu's Bday Charades</h1>
        <img src="Kirthu.png" alt="Family Logo" style="max-width: 150px; margin-bottom: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: block;">
        <p style="color: #ccc; margin-bottom: 30px;">Time to put Samajh into a real test</p>
        <button class="btn" onclick="showScreen('screen-create')">üëë Start New Game (Host)</button>
        <button class="btn btn-sec" onclick="showScreen('screen-join')">üëã Join Existing Game</button>
        <div onclick="showScreen('screen-admin-login')" style="color:#888; text-decoration:underline; padding:10px; cursor:pointer;">Admin Login</div>
    </div>

    <!-- 2. ADMIN -->
    <div id="screen-admin-login" class="screen">
        <h2>Admin Login</h2>
        <input type="text" id="adminUser" placeholder="Username (admin)" autocapitalize="none">
        <input type="password" id="adminPass" placeholder="Password (charades123)">
        <button class="btn" onclick="adminLogin()">Login</button>
        <button class="btn btn-sec" onclick="showScreen('screen-landing')">Back</button>
    </div>

    <div id="screen-admin-dash" class="screen">
        <h2>Add Words</h2>
        <div class="card">
            <select id="addType"><option value="Movie">Movie</option><option value="Song">Song</option></select>
            <select id="addDiff"><option value="Easy">Easy</option><option value="Medium">Medium</option><option value="Hard">Hard</option></select>
            <textarea id="addWords" rows="4" placeholder="Words separated by comma"></textarea>
        </div>
        <button class="btn btn-success" onclick="addWords()">Add Words</button>
        <p id="admin-msg" style="color: var(--success); height: 20px;"></p>
        <button class="btn btn-sec" onclick="showScreen('screen-landing')">Logout</button>
    </div>

    <!-- 3. CREATE ROOM -->
    <div id="screen-create" class="screen">
        <h2>Create Room</h2>
        <input type="text" id="c-roomName" placeholder="Room Name">
        <select id="c-gameType"><option value="Both">Movies & Songs</option><option value="Movie">Movies Only</option><option value="Song">Songs Only</option></select>
        <select id="c-teams" onchange="updateTeamInputs()"><option value="2">2 Teams</option><option value="3">3 Teams</option><option value="4">4 Teams</option></select>
        <div id="team-inputs"><input type="text" id="team1" value="Team A"><input type="text" id="team2" value="Team B"></div>
        <input type="number" id="c-duration" placeholder="Timer (sec)" value="60">
        <button class="btn" onclick="createRoom()">Create Room</button>
        <button class="btn btn-sec" onclick="showScreen('screen-landing')">Back</button>
    </div>

    <!-- 4. JOIN ROOM -->
    <div id="screen-join" class="screen">
        <h2>Join Game</h2>
        <input type="text" id="j-code" placeholder="Room Code (4 Letters)" maxlength="4" style="text-transform:uppercase;">
        <input type="text" id="j-name" placeholder="Your Name">
        <button class="btn" onclick="fetchRoomInfo()">Next</button>
        <button class="btn btn-sec" onclick="showScreen('screen-landing')">Back</button>
    </div>

    <!-- 4b. PICK TEAM -->
    <div id="screen-pick-team" class="screen">
        <h2>Pick Your Team</h2>
        <div id="team-buttons" style="width: 100%;"></div>
    </div>

    <!-- 5. GAME LOBBY -->
    <div id="screen-game" class="screen">
        <h2 id="g-roomName">Room</h2>
        <div class="card">
            <h3 style="border-bottom:1px solid #555;">üèÜ Scoreboard</h3>
            <div id="scoreboard"></div>
        </div>
        <div id="game-status-area" style="width: 100%;">
            <button class="btn" id="btn-myturn" onclick="startTurnSetup()">It's My Turn!</button>
            <p id="status-msg" style="color: #aaa; margin-top: 20px;">Waiting for turn...</p>
        </div>
    </div>

    <!-- 6. TURN SETUP -->
    <div id="screen-setup" class="screen">
        <h2>Your Turn!</h2>
        <div class="card">
            <label>Category</label>
            <select id="t-type"><option value="Movie">üé¨ Movie</option><option value="Song">üéµ Song</option></select>
            <label>Difficulty</label>
            <select id="t-diff"><option value="Easy">üü¢ Easy (x0.6)</option><option value="Medium">üü° Medium (x0.8)</option><option value="Hard">üî¥ Hard (x1.0)</option></select>
        </div>
        <button class="btn" onclick="confirmOptions()">Get Word</button>
        <button class="btn btn-sec" onclick="showScreen('screen-game')">Cancel</button>
    </div>

    <!-- 7. ACTOR SCREEN -->
    <div id="screen-actor" class="screen">
        <h3>You are acting!</h3>
        <div class="card" style="border: 2px solid var(--secondary);">
            <div id="actor-word" class="big-word">LOADING...</div>
            <p id="actor-meta" style="background: rgba(255,255,255,0.1); padding: 5px;"></p>
        </div>
        <button class="btn btn-success" id="btn-start-act" onclick="startActing()">‚ñ∂Ô∏è START TIMER</button>
        <div id="actor-controls" style="display:none; width: 100%;">
            <div class="timer-box" id="actor-timer">60</div>
            <button class="btn btn-success" onclick="wordFound()" style="padding: 25px;">‚úÖ GOT IT!</button>
        </div>
    </div>

    <!-- 8. GUESSER SCREEN -->
    <div id="screen-guesser" class="screen">
        <h2 id="guesser-status">Gamer is ready...</h2>
        <img src="Acting.png" alt="Family Logo" style="max-width: 150px; margin-bottom: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: block;">
        <div class="timer-box" id="guesser-timer" style="display:none; margin-top: 30px;">60</div>
    </div>

    <!-- REAL SOCKET LOGIC -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Initialize Real Socket
        const socket = io();

        // Debugging
        socket.on("connect", () => { console.log("Connected to server:", socket.id); });
        socket.on("connect_error", (err) => { 
            console.error("Connection failed:", err);
            alert("Connection Error. Please check if the server is running."); 
        });

        // --- APP LOGIC ---
        let myRoomCode = "";
        let myName = "";
        let myTeam = "";

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => { s.classList.remove('active'); s.style.display = 'none'; });
            const active = document.getElementById(id);
            active.style.display = 'flex';
            setTimeout(() => active.classList.add('active'), 10);
        }

        // --- ADMIN ---
        async function adminLogin() {
            const u = document.getElementById('adminUser').value;
            const p = document.getElementById('adminPass').value;
            try {
                const res = await fetch('/admin/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: u, password: p })
                });
                const data = await res.json();
                if(data.success) showScreen('screen-admin-dash');
                else alert("Invalid Login");
            } catch(e) { alert("Server Error"); }
        }

        async function addWords() {
            const type = document.getElementById('addType').value;
            const diff = document.getElementById('addDiff').value;
            const wordsRaw = document.getElementById('addWords').value;
            try {
                await fetch('/admin/add-words', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ type, difficulty: diff, wordsRaw })
                });
                document.getElementById('admin-msg').innerText = "‚úÖ Words Added!";
                setTimeout(() => document.getElementById('admin-msg').innerText = "", 2000);
            } catch(e) { alert("Error adding words"); }
        }

        // --- GAME CREATE/JOIN ---
        function updateTeamInputs() {
            const count = document.getElementById('c-teams').value;
            const div = document.getElementById('team-inputs');
            div.innerHTML = '';
            for(let i=1; i<=count; i++) div.innerHTML += `<input type="text" id="team${i}" placeholder="Team ${i}" value="Team ${String.fromCharCode(64+i)}">`;
        }

        function createRoom() {
            const roomName = document.getElementById('c-roomName').value;
            if(!roomName) return alert("Please enter a room name");
            
            const count = document.getElementById('c-teams').value;
            const teamNames = [];
            for(let i=1; i<=count; i++) teamNames.push(document.getElementById(`team${i}`).value);
            
            // EMIT TO SERVER
            console.log("Creating room...");
            socket.emit("create_room", { 
                roomName, 
                teamNames, 
                gameType: document.getElementById('c-gameType').value,
                duration: document.getElementById('c-duration').value 
            });
        }

        // LISTENERS
        socket.on("room_created", (data) => {
            console.log("Room Created:", data);
            document.getElementById('j-code').value = data.roomCode;
            showScreen('screen-join');
        });

        function fetchRoomInfo() {
            myRoomCode = document.getElementById('j-code').value.toUpperCase();
            myName = document.getElementById('j-name').value;
            if(!myRoomCode || !myName) return alert("Fill all fields");
            socket.emit("join_room", { roomCode: myRoomCode, playerName: myName, teamName: "Pending" });
        }

        socket.on("update_lobby", (data) => {
            const scoreDiv = document.getElementById('scoreboard');
            scoreDiv.innerHTML = '';
            for (const [team, score] of Object.entries(data.scores)) {
                scoreDiv.innerHTML += `<div class="score-row"><span>${team}</span><span style="font-weight:bold; color:var(--secondary);">${score}</span></div>`;
            }
            document.getElementById('g-roomName').innerText = `${data.config.roomName} (${myRoomCode})`;
            
            if (myTeam === "") {
                const btnDiv = document.getElementById('team-buttons');
                btnDiv.innerHTML = '';
                data.config.teamNames.forEach(t => {
                    const btn = document.createElement('button');
                    btn.className = "btn";
                    btn.innerText = "Join " + t;
                    btn.onclick = () => { confirmTeam(t); };
                    btnDiv.appendChild(btn);
                });
                showScreen('screen-pick-team');
            }
        });

        function confirmTeam(team) {
            myTeam = team;
            socket.emit("join_room", { roomCode: myRoomCode, playerName: myName, teamName: team });
            showScreen('screen-game');
        }

        // --- TURNS ---
        function startTurnSetup() { socket.emit("setup_turn", { roomCode: myRoomCode }); }
        socket.on("show_turn_options", () => showScreen('screen-setup'));
        
        function confirmOptions() { 
            const type = document.getElementById('t-type').value;
            const diff = document.getElementById('t-diff').value;
            socket.emit("get_word", { roomCode: myRoomCode, type, difficulty: diff }); 
        }

        socket.on("receive_word", (wordObj) => {
            showScreen('screen-actor');
            document.getElementById('actor-word').innerText = wordObj.word;
            document.getElementById('actor-meta').innerText = `${wordObj.type} ‚Ä¢ ${wordObj.difficulty}`;
            document.getElementById('btn-start-act').style.display = "block";
            document.getElementById('actor-controls').style.display = "none";
        });

        socket.on("gamer_getting_ready", () => {
            showScreen('screen-guesser');
            document.getElementById('guesser-status').innerText = "Actor is preparing...";
            document.getElementById('guesser-timer').style.display = "none";
        });

        function startActing() { socket.emit("start_acting", { roomCode: myRoomCode }); }

        socket.on("game_started", ({ duration }) => {
            if(document.getElementById('screen-actor').classList.contains('active')) { // Check class instead of display for robustness
                document.getElementById('btn-start-act').style.display = "none";
                document.getElementById('actor-controls').style.display = "block";
                startTimer('actor-timer', duration);
            } else {
                document.getElementById('guesser-status').innerText = "ACTING IN PROGRESS!";
                document.getElementById('guesser-timer').style.display = "block";
                startTimer('guesser-timer', duration);
            }
        });

        function wordFound() { socket.emit("word_found", { roomCode: myRoomCode }); }

        socket.on("turn_ended", (data) => {
            clearInterval(timerInterval);
            showScreen('screen-game');
            if(data.success) alert(`‚úÖ Word Found! Team ${data.team} gets ${data.score} points!`);
            else alert("‚è∞ Time's up!");
        });
        
        socket.on("update_scores", (scores) => {
            const scoreDiv = document.getElementById('scoreboard');
            scoreDiv.innerHTML = '';
            for (const [team, score] of Object.entries(scores)) scoreDiv.innerHTML += `<div class="score-row"><span>${team}</span><span style="font-weight:bold; color:var(--secondary);">${score}</span></div>`;
        });
        
        socket.on("error_msg", (msg) => alert(msg));

        let timerInterval;
        function startTimer(elemId, seconds) {
            const el = document.getElementById(elemId);
            el.innerText = seconds;
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                seconds--; el.innerText = seconds;
                if(seconds <= 0) clearInterval(timerInterval);
            }, 1000);
        }
    </script>
</body>
</html>
